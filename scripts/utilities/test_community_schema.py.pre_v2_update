#!/usr/bin/env python3
"""
Test the Community Edition 2025.1 schema with proper VECTOR columns and HNSW indexes.
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from common.iris_connector import IRISConnector

def test_community_schema():
    """Test the schema creation and vector operations with Community Edition."""
    
    print("=" * 60)
    print("TESTING COMMUNITY EDITION 2025.1 SCHEMA")
    print("=" * 60)
    
    # Connect to Community Edition on standard port
    connector = IRISConnector(
        host="localhost",
        port=1972,
        namespace="USER",
        username="_SYSTEM",
        password="SYS"
    )
    
    try:
        # Test connection
        print("\n1. Testing connection...")
        conn = connector.get_connection()
        cursor = conn.cursor()
        print("✅ Connected to IRIS Community Edition")
        
        # Load and execute schema
        print("\n2. Creating schema...")
        schema_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), 
                                   "common", "db_init_community_2025.sql")
        
        with open(schema_path, 'r') as f:
            schema_sql = f.read()
        
        # Execute schema in chunks (split by semicolon)
        statements = [stmt.strip() for stmt in schema_sql.split(';') if stmt.strip()]
        
        for i, statement in enumerate(statements):
            if statement.startswith('--') or not statement:
                continue
            try:
                print(f"Executing statement {i+1}/{len(statements)}: {statement[:50]}...")
                cursor.execute(statement)
                print(f"✅ Statement {i+1} executed successfully")
            except Exception as e:
                print(f"❌ Statement {i+1} failed: {e}")
                print(f"Statement: {statement}")
        
        print("✅ Schema created successfully")
        
        # Test VECTOR column creation
        print("\n3. Testing VECTOR columns...")
        cursor.execute("""
            SELECT COLUMN_NAME, DATA_TYPE 
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = 'RAG' 
            AND TABLE_NAME = 'SourceDocuments' 
            AND COLUMN_NAME = 'embedding'
        """)
        result = cursor.fetchone()
        if result:
            print(f"✅ VECTOR column created: {result[0]} ({result[1]})")
        else:
            print("❌ VECTOR column not found")
        
        # Test TO_VECTOR function
        print("\n4. Testing TO_VECTOR function...")
        test_vector = "0.1,0.2,0.3,0.4"
        cursor.execute(f"SELECT TO_VECTOR('{test_vector}', double) AS test_vector")
        result = cursor.fetchone()
        if result:
            print(f"✅ TO_VECTOR works: {result[0]}")
        else:
            print("❌ TO_VECTOR failed")
        
        # Test vector similarity functions
        print("\n5. Testing vector similarity functions...")
        cursor.execute("""
            SELECT VECTOR_COSINE(
                TO_VECTOR('1.0,0.0,0.0,0.0', double),
                TO_VECTOR('0.0,1.0,0.0,0.0', double)
            ) AS cosine_similarity
        """)
        result = cursor.fetchone()
        if result:
            print(f"✅ VECTOR_COSINE works: {result[0]}")
        else:
            print("❌ VECTOR_COSINE failed")
        
        # Test data insertion with VECTOR
        print("\n6. Testing data insertion...")
        test_embedding = "0.1,0.2,0.3,0.4"
        cursor.execute(f"""
            INSERT INTO RAG.SourceDocuments (doc_id, title, text_content, embedding)
            VALUES ('test_doc_1', 'Test Document', 'This is a test document.', 
                    TO_VECTOR('{test_embedding}', double))
        """)
        print("✅ Data insertion successful")
        
        # Test vector similarity query
        print("\n7. Testing vector similarity query...")
        query_embedding = "0.1,0.2,0.3,0.4"
        cursor.execute(f"""
            SELECT doc_id, title, 
                   VECTOR_COSINE(embedding, TO_VECTOR('{query_embedding}', double)) AS similarity
            FROM RAG.SourceDocuments 
            WHERE embedding IS NOT NULL
            ORDER BY similarity DESC
        """)
        results = cursor.fetchall()
        if results:
            print(f"✅ Vector similarity query works: {len(results)} results")
            for row in results:
                print(f"   {row[0]}: {row[1]} (similarity: {row[2]})")
        else:
            print("❌ Vector similarity query failed")
        
        # Test HNSW index existence
        print("\n8. Testing HNSW indexes...")
        cursor.execute("""
            SELECT INDEX_NAME, INDEX_TYPE 
            FROM INFORMATION_SCHEMA.INDEXES 
            WHERE TABLE_SCHEMA = 'RAG' 
            AND INDEX_NAME LIKE '%hnsw%'
        """)
        indexes = cursor.fetchall()
        if indexes:
            print(f"✅ HNSW indexes created: {len(indexes)} indexes")
            for idx in indexes:
                print(f"   {idx[0]} ({idx[1]})")
        else:
            print("❌ No HNSW indexes found")
        
        print("\n" + "=" * 60)
        print("COMMUNITY EDITION SCHEMA TEST COMPLETE")
        print("=" * 60)
        
        return True
        
    except Exception as e:
        print(f"❌ Test failed: {e}")
        import traceback
        traceback.print_exc()
        return False
    
    finally:
        if 'cursor' in locals():
            cursor.close()
        if 'conn' in locals():
            conn.close()

if __name__ == "__main__":
    success = test_community_schema()
    sys.exit(0 if success else 1)