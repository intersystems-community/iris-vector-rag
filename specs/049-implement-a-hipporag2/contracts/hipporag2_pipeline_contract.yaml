# HippoRAG2 Pipeline Contract
# API: HippoRAG2Pipeline.query() and HippoRAG2Pipeline.load_documents()
# Spec Reference: FR-034 (pipeline factory integration), FR-042-045 (compatibility requirements)

contract_version: "1.0.0"
pipeline_name: "hipporag2"
base_class: "iris_rag.core.rag_pipeline.RAGPipeline"

---

## Method: query()

### Signature
```python
def query(
    self,
    query: str,
    top_k: int = 20,
    **kwargs
) -> Dict[str, Any]
```

### Parameters
| Name | Type | Required | Default | Description | Validation |
|------|------|----------|---------|-------------|------------|
| `query` | str | Yes | N/A | Natural language question | Non-empty string, ≤1000 chars |
| `top_k` | int | No | 20 | Number of passages to retrieve | 1 ≤ top_k ≤ 100 |
| `kwargs` | dict | No | {} | Additional pipeline-specific params | See optional params below |

### Optional Parameters (via kwargs)
- `enable_graph_expansion` (bool): Enable/disable graph expansion stage (default: True)
- `graph_expansion_hops` (int): Number of hops for graph traversal (default: 2, max: 3)
- `entity_linking_threshold` (float): Minimum confidence for entity linking (default: 0.5)
- `generate_answer` (bool): Whether to generate LLM answer (default: True)

### Return Value (RAGAS-Compatible)
```python
{
    # Required fields (spec FR-042, FR-043)
    "answer": str,                          # LLM-generated answer
    "retrieved_documents": List[Document],  # LangChain Document objects with metadata
    "contexts": List[str],                  # Text content for RAGAS evaluation
    "sources": List[str],                   # Source document IDs
    "execution_time": float,                # Total time in seconds
    "metadata": {                           # Pipeline-specific metadata (FR-045)
        "num_retrieved": int,               # Number of documents retrieved
        "pipeline_type": "hipporag2",
        "generated_answer": bool,
        "processing_time": float,           # Same as execution_time
        "retrieval_method": str,            # "multi_stage_graph_enhanced"
        "context_count": int,
        
        # HippoRAG2-specific metadata
        "query_entities": List[str],        # Entities extracted from query
        "expanded_entities": List[str],     # Entities after graph expansion
        "graph_expansion_time_ms": int,
        "entity_linking_time_ms": int,
        "passage_ranking_time_ms": int,
        "llm_generation_time_ms": int,
        "supporting_entity_count": int,
        "graph_hops_used": int
    }
}
```

### Error Conditions
| Condition | Exception | HTTP Status | Message |
|-----------|-----------|-------------|---------|
| Empty query | `ValueError` | 400 | "Query cannot be empty" |
| Query too long | `ValueError` | 400 | "Query exceeds 1000 character limit" |
| Invalid top_k | `ValueError` | 400 | "top_k must be between 1 and 100" |
| Pipeline not indexed | `RuntimeError` | 500 | "No documents indexed. Call load_documents() first" |
| LLM API failure | `LLMAPIException` | 503 | "LLM service unavailable: {details}" |
| IRIS connection error | `DatabaseException` | 503 | "Database connection failed: {details}" |

### Performance Requirements (from spec NFR-005)
- Execution time < 2 seconds for queries at 1M document scale
- 95th percentile latency < 3 seconds

### Example Request/Response
```python
# Request
result = pipeline.query(
    query="What county is Erik Hort's birthplace a part of?",
    top_k=5,
    graph_expansion_hops=2
)

# Response
{
    "answer": "Rockland County",
    "retrieved_documents": [
        {
            "page_content": "Erik Hort's birthplace is Montebello.",
            "metadata": {"source": "doc_7", "score": 0.95, "doc_id": "abc-123"}
        },
        {
            "page_content": "Montebello is a part of Rockland County.",
            "metadata": {"source": "doc_9", "score": 0.92, "doc_id": "def-456"}
        }
    ],
    "contexts": [
        "Erik Hort's birthplace is Montebello.",
        "Montebello is a part of Rockland County."
    ],
    "sources": ["doc_7", "doc_9"],
    "execution_time": 1.23,
    "metadata": {
        "num_retrieved": 2,
        "pipeline_type": "hipporag2",
        "generated_answer": true,
        "processing_time": 1.23,
        "retrieval_method": "multi_stage_graph_enhanced",
        "context_count": 2,
        "query_entities": ["Erik Hort"],
        "expanded_entities": ["Erik Hort", "Montebello", "Rockland County"],
        "graph_expansion_time_ms": 120,
        "entity_linking_time_ms": 50,
        "passage_ranking_time_ms": 180,
        "llm_generation_time_ms": 250,
        "supporting_entity_count": 3,
        "graph_hops_used": 2
    }
}
```

---

## Method: load_documents()

### Signature
```python
def load_documents(
    self,
    documents_path: str = "",
    documents: List[Document] = None,
    **kwargs
) -> None
```

### Parameters
| Name | Type | Required | Default | Description | Validation |
|------|------|----------|---------|-------------|------------|
| `documents_path` | str | No | "" | Path to document file/directory | Valid path if provided |
| `documents` | List[Document] | No | None | LangChain Document objects | Valid Document objects |
| `kwargs` | dict | No | {} | Additional indexing params | See optional params |

**Note**: Exactly one of `documents_path` or `documents` must be provided.

### Optional Parameters (via kwargs)
- `batch_size` (int): Documents per batch (default: 100, max: 1000)
- `enable_checkpointing` (bool): Enable resume capability (default: True)
- `session_id` (str): Resume existing session (default: auto-generate)
- `skip_entity_extraction` (bool): Skip extraction, use existing (default: False)
- `show_progress` (bool): Display progress bar (default: True per FR-039)

### Return Value
- None (raises exception on failure)

### Side Effects
1. Extracts entities and relationships from documents
2. Generates embeddings for passages and entities
3. Stores knowledge graph in IRIS (entities + relationships)
4. Creates checkpoints for resume capability (spec FR-008a/b/c)
5. Updates operational counters (spec FR-041a)

### Error Conditions
| Condition | Exception | HTTP Status | Message |
|-----------|-----------|-------------|---------|
| No documents provided | `ValueError` | 400 | "Either documents_path or documents must be provided" |
| Both params provided | `ValueError` | 400 | "Provide only one of documents_path or documents" |
| Invalid document format | `ValueError` | 400 | "Invalid document format: {details}" |
| File not found | `FileNotFoundError` | 404 | "Document file not found: {path}" |
| LLM extraction failure | `EntityExtractionException` | 500 | "Entity extraction failed after 3 retries: {details}" (per FR-002a) |
| IRIS storage failure | `DatabaseException` | 500 | "Failed to store entities in IRIS: {details}" |

### Performance Requirements (from spec NFR-004, NFR-006)
- Indexing throughput ≥ 167 documents/minute (10K docs in <1 hour)
- Checkpoint overhead < 5% of total indexing time

### Example Usage
```python
# Option 1: Load from file
pipeline.load_documents(
    documents_path="/data/documents.json",
    batch_size=100,
    enable_checkpointing=True
)

# Option 2: Load from Document objects
from langchain.schema import Document

docs = [
    Document(page_content="Erik Hort's birthplace is Montebello.", metadata={"source": "doc_7"}),
    Document(page_content="Montebello is a part of Rockland County.", metadata={"source": "doc_9"})
]

pipeline.load_documents(
    documents=docs,
    batch_size=10,
    show_progress=True
)
```

---

## Backward Compatibility (spec FR-042)

### Deprecated Parameter Support
- `query_text` (deprecated): Aliased to `query` parameter
- Warn user if deprecated parameter used

### Version Migration
- v1.0.0: Initial HippoRAG2 implementation
- Future versions must maintain query() and load_documents() signatures
- Breaking changes require major version bump

---

## Test Requirements

### Contract Test Coverage
1. **query() tests**:
   - ✗ Test query with indexed documents → returns valid response
   - ✗ Test query without indexed documents → raises RuntimeError
   - ✗ Test query with empty string → raises ValueError
   - ✗ Test query with top_k=0 → raises ValueError
   - ✗ Test query with top_k=1000 → raises ValueError
   - ✗ Test response contains all required fields (answer, contexts, sources, metadata)
   - ✗ Test metadata contains HippoRAG2-specific fields
   - ✗ Test multi-hop query returns correct supporting entities

2. **load_documents() tests**:
   - ✗ Test load with valid documents → succeeds without error
   - ✗ Test load with no documents → raises ValueError
   - ✗ Test load with both params → raises ValueError
   - ✗ Test load with invalid file path → raises FileNotFoundError
   - ✗ Test checkpointing creates progress record in IRIS
   - ✗ Test resume from checkpoint skips already-processed documents
   - ✗ Test batch processing commits every N documents
   - ✗ Test progress bar displays during indexing (FR-039)

**All tests must FAIL initially** (TDD requirement from Constitution III)

---

**Contract Status**: ✅ Complete - Ready for test generation
