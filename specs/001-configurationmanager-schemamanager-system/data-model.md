# Data Model: ConfigurationManager → SchemaManager System

## Overview
The ConfigurationManager → SchemaManager system manages configuration state and database schema evolution for the RAG framework. This document defines the core data entities and their relationships.

## Core Data Entities

### ConfigurationManager State

#### Configuration Hierarchy
```
Configuration
├── database (Database connection settings)
│   ├── host: string
│   ├── port: string
│   ├── namespace: string
│   ├── username: string
│   └── password: string
├── embeddings (Embedding model configuration)
│   ├── model: string
│   ├── dimension: integer
│   └── provider: string
├── vector_index (HNSW index parameters)
│   ├── type: string = "HNSW"
│   ├── M: integer = 16
│   ├── efConstruction: integer = 200
│   └── Distance: string = "COSINE"
├── logging (Logging configuration)
│   ├── level: string = "INFO"
│   ├── path: string
│   └── format: string
└── pipelines (Pipeline-specific settings)
    └── [pipeline_type]: object
```

#### Environment Variable Mapping
```
RAG_DATABASE__IRIS__HOST → config["database"]["iris"]["host"]
RAG_EMBEDDINGS__MODEL → config["embeddings"]["model"]
RAG_VECTOR_INDEX__M → config["vector_index"]["M"]
```

### SchemaManager State

#### Table Configurations
```
TableConfiguration {
    table_name: string
    embedding_column: string | null
    uses_document_embeddings: boolean
    default_model: string
    dimension: integer
    supports_vector_search: boolean
    supports_graph_traversal: boolean
    table_type: string
    created_by: string
    expected_columns: string[]
    foreign_keys: ForeignKey[]
    indexes: string[]
}
```

#### Model-Dimension Mapping
```
ModelDimensions {
    "all-MiniLM-L6-v2": 384
    "all-mpnet-base-v2": 768
    "text-embedding-ada-002": 1536
    "text-embedding-3-small": 1536
    "text-embedding-3-large": 3072
    [custom_model]: integer
}
```

### Database Schema Entities

#### SchemaMetadata Table
```sql
CREATE TABLE RAG.SchemaMetadata (
    table_name VARCHAR(255) PRIMARY KEY,
    schema_version VARCHAR(50) NOT NULL,
    vector_dimension INTEGER,
    embedding_model VARCHAR(255),
    configuration JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

#### Managed Tables

##### SourceDocuments
```sql
CREATE TABLE RAG.SourceDocuments (
    id VARCHAR(255) PRIMARY KEY,
    doc_id VARCHAR(255) UNIQUE,
    title VARCHAR(1000),
    abstract TEXT,
    text_content LONGVARCHAR,
    authors TEXT,
    keywords TEXT,
    embedding VECTOR(FLOAT, dimension),
    metadata TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

##### DocumentChunks
```sql
CREATE TABLE RAG.DocumentChunks (
    id VARCHAR(255) PRIMARY KEY,
    chunk_id VARCHAR(255),
    doc_id VARCHAR(255),
    chunk_text TEXT,
    chunk_embedding VECTOR(FLOAT, dimension),
    chunk_index INTEGER,
    chunk_type VARCHAR(100),
    metadata TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (doc_id) REFERENCES RAG.SourceDocuments(id)
)
```

##### Entities
```sql
CREATE TABLE RAG.Entities (
    entity_id VARCHAR(255) PRIMARY KEY,
    entity_name VARCHAR(1000) NOT NULL,
    entity_type VARCHAR(255) NOT NULL,
    source_doc_id VARCHAR(255) NOT NULL,
    description TEXT,
    embedding VECTOR(FLOAT, dimension),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (source_doc_id) REFERENCES RAG.SourceDocuments(id) ON DELETE CASCADE
)
```

##### EntityRelationships
```sql
CREATE TABLE RAG.EntityRelationships (
    relationship_id VARCHAR(255) PRIMARY KEY,
    source_entity_id VARCHAR(255) NOT NULL,
    target_entity_id VARCHAR(255) NOT NULL,
    relationship_type VARCHAR(255) NOT NULL,
    metadata TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (source_entity_id) REFERENCES RAG.Entities(entity_id) ON DELETE CASCADE,
    FOREIGN KEY (target_entity_id) REFERENCES RAG.Entities(entity_id) ON DELETE CASCADE
)
```

#### IRIS Graph Core Tables

##### rdf_labels
```sql
CREATE TABLE rdf_labels (
    s VARCHAR(256) NOT NULL,     -- subject
    label VARCHAR(128) NOT NULL  -- entity type/label
)
```

##### rdf_props
```sql
CREATE TABLE rdf_props (
    s VARCHAR(256) NOT NULL,    -- subject
    key VARCHAR(128) NOT NULL,  -- property key
    val VARCHAR(4000)           -- property value
)
```

##### rdf_edges
```sql
CREATE TABLE rdf_edges (
    edge_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    s VARCHAR(256) NOT NULL,          -- subject
    p VARCHAR(128) NOT NULL,          -- predicate
    o_id VARCHAR(256) NOT NULL,       -- object
    qualifiers JSON                   -- metadata with confidence
)
```

##### kg_NodeEmbeddings_optimized
```sql
CREATE TABLE kg_NodeEmbeddings_optimized (
    id VARCHAR(256) PRIMARY KEY,     -- entity identifier
    emb VECTOR(FLOAT, dimension)     -- optimized vector embedding
)
```

## Data Flow Patterns

### Configuration Loading Flow
```
1. Load YAML configuration file
2. Apply environment variable overrides
3. Validate required keys
4. Cache configuration in memory
5. Provide typed access methods
```

### Schema Migration Flow
```
1. Get current schema config from SchemaMetadata
2. Generate expected schema config from configuration
3. Compare current vs expected
4. If different, execute migration:
   a. Begin transaction
   b. Drop/recreate table with new schema
   c. Update SchemaMetadata
   d. Create indexes
   e. Commit or rollback on error
```

### Vector Dimension Resolution Flow
```
1. Check dimension cache
2. Get table configuration
3. If model override specified, use model mapping
4. Return cached dimension
5. Validate dimension consistency across components
```

## Indexing Strategy

### Vector Indexes
- HNSW indexes with ACORN=1 optimization when available
- Fallback to standard HNSW for compatibility
- Index names follow pattern: `idx_{table}_{column}`

### Performance Indexes
- Foreign key columns automatically indexed
- Entity name and type columns indexed for GraphRAG queries
- Created timestamp columns indexed for temporal queries

## Data Integrity Constraints

### Referential Integrity
- DocumentChunks → SourceDocuments (CASCADE DELETE)
- Entities → SourceDocuments (CASCADE DELETE)
- EntityRelationships → Entities (CASCADE DELETE)

### Schema Versioning
- Schema versions follow semantic versioning
- Breaking changes increment major version
- Compatible additions increment minor version
- Bug fixes increment patch version

### Vector Dimension Consistency
- All vector columns within a table must have same dimension
- Dimension determined by embedding model configuration
- SchemaManager enforces consistency across pipeline components

## Caching Strategy

### Configuration Cache
- In-memory cache for configuration values
- Cache invalidated on configuration reload
- Environment variable changes require restart

### Dimension Cache
- LRU cache for table/model dimension lookups
- Cache key format: `{table_name}:{model_name}`
- Cache cleared on model registration

## Error Handling Patterns

### Configuration Errors
- `ConfigValidationError` for missing required keys
- Type casting failures return original string value
- Environment variable parsing errors logged but non-fatal

### Schema Migration Errors
- Transaction rollback on any migration failure
- Clear error messages with context
- Graceful degradation when metadata table unavailable

### Dimension Validation Errors
- `ValueError` for dimension mismatches
- Hard failure prevents silent configuration issues
- Actionable error messages for troubleshooting