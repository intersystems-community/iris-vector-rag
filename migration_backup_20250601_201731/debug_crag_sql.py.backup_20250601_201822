#!/usr/bin/env python3
"""
Debug script to see the exact SQL being generated by CRAG
"""

import sys
import os
sys.path.insert(0, os.path.abspath('.'))

from common.utils import get_embedding_func

def debug_crag_sql():
    """Debug CRAG SQL generation"""
    print("Debugging CRAG SQL generation...")
    
    # Initialize embedding function
    embedding_func = get_embedding_func()
    
    # Generate a test embedding
    query = "What are the symptoms of diabetes?"
    query_embedding = embedding_func([query])[0]
    query_embedding_str = ','.join([f'{x:.10f}' for x in query_embedding])
    
    print(f"Query: {query}")
    print(f"Embedding length: {len(query_embedding)}")
    print(f"Embedding string length: {len(query_embedding_str)}")
    print(f"First 100 chars of embedding: {query_embedding_str[:100]}...")
    
    # Generate the SQL that CRAG would use
    top_k = 5
    similarity_threshold = 0.0
    schema = "RAG"
    
    sql_query = f"""
        SELECT TOP {top_k * 2} 
            doc_id, 
            title, 
            text_content,
            VECTOR_COSINE(document_embedding_vector, TO_VECTOR('{query_embedding_str}', 'DOUBLE', 384)) as similarity_score
        FROM {schema}.SourceDocuments
        WHERE document_embedding_vector IS NOT NULL
        AND VECTOR_COSINE(document_embedding_vector, TO_VECTOR('{query_embedding_str}', 'DOUBLE', 384)) > {similarity_threshold}
        ORDER BY similarity_score DESC
    """
    
    print(f"\nGenerated SQL:")
    print(sql_query)
    
    # Compare with BasicRAG format
    basic_rag_sql = f"""
        SELECT TOP {top_k} 
            doc_id, 
            title, 
            text_content,
            VECTOR_COSINE(document_embedding_vector, TO_VECTOR('{query_embedding_str}', 'DOUBLE', 384)) as similarity_score
        FROM {schema}.SourceDocuments
        WHERE document_embedding_vector IS NOT NULL
        AND VECTOR_COSINE(document_embedding_vector, TO_VECTOR('{query_embedding_str}', 'DOUBLE', 384)) > {similarity_threshold}
        ORDER BY similarity_score DESC
    """
    
    print(f"\nBasicRAG SQL format:")
    print(basic_rag_sql)

if __name__ == "__main__":
    debug_crag_sql()