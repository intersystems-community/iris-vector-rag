"""Debug the refactored pipeline SQL issue"""

from common.utils import get_embedding_func
from common.connection_manager import get_connection_manager

# Get connection manager
cm = get_connection_manager()
print(f"Connection type: {cm.connection_type}")

# Generate a test embedding
embedding_func = get_embedding_func()
test_embedding = embedding_func(["test query"])[0]
embedding_str = ','.join([f'{x:.10f}' for x in test_embedding])

# Build the SQL query
top_k = 3
similarity_threshold = 0.1

sql = f"""
    SELECT TOP {top_k} 
        doc_id, 
        title, 
        text_content,
        VECTOR_COSINE(
            TO_VECTOR(embedding, 'DOUBLE', 384),
            TO_VECTOR('{embedding_str}', 'DOUBLE', 384)
        ) as similarity_score
    FROM RAG.SourceDocuments_V2
    WHERE embedding IS NOT NULL
    AND VECTOR_COSINE(
        TO_VECTOR(embedding, 'DOUBLE', 384),
        TO_VECTOR('{embedding_str}', 'DOUBLE', 384)
    ) > {similarity_threshold}
    ORDER BY similarity_score DESC
"""

print("\nSQL Query:")
print(sql[:200] + "...")

# Try to execute
try:
    results = cm.execute(sql)
    print(f"\nSuccess! Retrieved {len(results)} results")
except Exception as e:
    print(f"\nError: {e}")
    
    # Try a simpler query
    print("\nTrying simpler query...")
    try:
        simple_sql = "SELECT TOP 1 doc_id, title FROM RAG.SourceDocuments_V2 WHERE embedding IS NOT NULL"
        results = cm.execute(simple_sql)
        print(f"Simple query success! Retrieved {len(results)} results")
    except Exception as e2:
        print(f"Simple query error: {e2}")