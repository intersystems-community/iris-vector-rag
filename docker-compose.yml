# Docker Compose for RAG Templates IRIS Database
# Uses "out of the way" ports to avoid conflicts with existing IRIS installations
# Compatible with both Community and Enterprise/Licensed IRIS images
# IRIS standard ports: 1972 (SuperServer), 52773 (Management Portal)
# Mapped to: 11972 (SuperServer), 15273 (Management Portal)

services:
  iris_db:
    image: intersystemsdc/iris-community:latest
    container_name: iris_db_rag_templates
    ports:
      - "11972:1972"   # IRIS SuperServer port: container 1972 → host 11972
      - "15273:52773"  # IRIS Management Portal: container 52773 → host 15273
    environment:
      - IRISNAMESPACE=USER
      - ISC_DEFAULT_PASSWORD=SYS
    volumes:
      - iris_db_data:/usr/irissys/mgr # Named volume for IRIS data persistence
      - .:/home/irisowner/dev # Mount project directory for ZPM access
    stdin_open: true # Keep container running
    tty: true        # Keep container running
    healthcheck:
      test: ["CMD", "/usr/irissys/bin/iris", "session", "iris", "-U%SYS", "##class(%SYSTEM.Process).CurrentDirectory()"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Disable password expiration for all accounts using Security.Users.UnExpireUserPasswords()
    command: --check-caps false -a "iris session iris -U%SYS '##class(Security.Users).UnExpireUserPasswords(\"*\")'"

volumes:
  iris_db_data: {} # Defines the named volume for IRIS data

# =============================================================================
# USAGE INSTRUCTIONS FOR RAG TEMPLATES IRIS DATABASE
# =============================================================================
#
# 1. Start IRIS database:
#    docker-compose up -d
#
# 2. IRIS will be available on these ports:
#    - SuperServer: localhost:11972 (for applications)
#    - Management Portal: http://localhost:15273/csp/sys/UtilHome.csp
#    - Credentials: _SYSTEM / SYS
#
# 3. Update .env file to match these ports:
#    IRIS_PORT=11972
#    IRIS_WEBSERVER_PORT=15273
#
# 4. Database initialization:
#    make setup-db    # Creates all tables
#    make load-data   # Loads sample data
#
# IMAGE COMPATIBILITY:
# - Default: intersystemsdc/iris-community:latest (Community Edition)
# - Can be changed to any IRIS image (Enterprise, Licensed, etc.)
# - Simply update the 'image:' line above
#
# PORT MAPPING STRATEGY:
# - Default IRIS:    11972 (SuperServer), 15273 (Portal)
# - Licensed IRIS:   21972 (SuperServer), 25273 (Portal) [see docker-compose.licensed.yml]
# - Standard IRIS:    1972 (SuperServer), 52773 (Portal) - reserved for existing installations
#
# ADVANCED: For licensed IRIS with ACORN=1 HNSW optimization, use docker-compose.licensed.yml