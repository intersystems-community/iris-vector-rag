version: '3.8'

services:
  iris-db:
    image: intersystemsdc/iris-community:latest
    container_name: iris_db_service # Renamed for clarity
    ports:
      - "1972:1972"   # IRIS SuperServer port (host:container)
      - "52773:52773"  # IRIS Management Portal (host:container)
    environment:
      - IRISUSERNAME=SuperUser
      - IRISPASSWORD=SYS
      - IRISNAMESPACE=USER
    volumes:
      - iris_db_data:/usr/irissys/mgr # Named volume for IRIS data persistence
    # Add healthcheck for IRIS if needed
    # healthcheck:
    #   test: ["CMD", "iris", "session", "iris", "-U", "%SYS", "'##class(%SYS.System).IsFullyUp()'"] # Example
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5

  app:
    build:
      context: .
      dockerfile: app.Dockerfile # Use the app.Dockerfile for the Python app
    container_name: python_app_service # Renamed for clarity
    environment:
      # Environment variables for Python application
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # ODBC environment variables
      - ODBCINI=/app/odbc.ini
      - ODBCSYSINI=/app
      # For pyodbc DSN-less connection string if DSN [IRIS] in odbc.ini (inside container) doesn't work
      # The odbc.ini copied by app.Dockerfile should point Host to 'iris-db'
      - IRIS_HOSTNAME_DOCKER=iris-db # Service name of the IRIS container
      - IRIS_PORT_DOCKER=1972
      - IRIS_NAMESPACE_DOCKER=USER
      - IRIS_UID_DOCKER=SuperUser
      - IRIS_PWD_DOCKER=SYS
      # For sqlalchemy-iris connection string
      - IRIS_CONNECTION_STRING_SQLALCHEMY=iris://SuperUser:SYS@iris-db:1972/USER
    volumes:
      # Use a more specific volume mount that doesn't override Python packages
      - ./basic_rag:/app/basic_rag
      - ./colbert:/app/colbert
      - ./common:/app/common
      - ./crag:/app/crag
      - ./data:/app/data
      - ./eval:/app/eval
      - ./graphrag:/app/graphrag
      - ./hyde:/app/hyde
      - ./noderag:/app/noderag
      - ./tests:/app/tests
      - ./bin:/app/bin
      - ./odbc.ini:/app/odbc.ini
      - ./odbcinst_docker.ini:/app/odbcinst_docker.ini
      - ./test_pyodbc_vector_ops.py:/app/test_pyodbc_vector_ops.py
      - ./test_iris_dbapi_vector_ops.py:/app/test_iris_dbapi_vector_ops.py
      - ./test_iris_vector_workarounds.py:/app/test_iris_vector_workarounds.py
    depends_on:
      - iris-db
    # Keep the container running to allow `docker exec`
    stdin_open: true
    tty: true

volumes:
  iris_db_data: {} # Define the named volume for the IRIS DB service

# All services will be on the default Docker network created for this compose file,
# allowing them to reach each other by service name.
