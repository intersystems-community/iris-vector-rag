# Docker Compose for Licensed IRIS with ACORN=1 HNSW Optimization
# For users with licensed InterSystems IRIS (not Community Edition)
# Provides enhanced HNSW performance with ACORN=1 algorithm for iris_graph_core
# Uses "out of the way" ports to avoid conflicts with existing IRIS installations
# IRIS standard ports: 1972 (SuperServer), 52773 (Management Portal)
# Mapped to: 21972 (SuperServer), 252773 (Management Portal) - different from community

services:
  iris_db:
    image: intersystemsdc/iris-community:2025.3.0EHAT.127.0-linux-arm64v8  # Licensed IRIS with ML features and ACORN=1
    container_name: iris_db_rag_licensed
    ports:
      - "1972:1972"   # IRIS SuperServer port: container 1972 → host 1972
      - "52773:52773" # IRIS Management Portal: container 52773 → host 52773
    environment:
      - IRISNAMESPACE=USER
      - ISC_DEFAULT_PASSWORD=SYS
    volumes:
      - iris_db_data_licensed:/usr/irissys/mgr # Named volume for IRIS data persistence
      - .:/home/irisowner/dev # Mount project directory for ZPM access
      # License key file for vector search capabilities:
      - ./iris.key:/usr/irissys/mgr/iris.key # Map the license key
    stdin_open: true # Keep container running
    tty: true        # Keep container running
    healthcheck:
      test: ["CMD", "/usr/irissys/bin/iris", "session", "iris", "-U%SYS", "##class(%SYSTEM.Process).CurrentDirectory()"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Simplified startup
    command: --check-caps false

volumes:
  iris_db_data_licensed: {} # Defines the named volume for licensed IRIS data

# =============================================================================
# USAGE INSTRUCTIONS FOR LICENSED IRIS WITH IRIS GRAPH CORE
# =============================================================================
#
# 1. Start licensed IRIS (instead of community edition):
#    docker-compose -f docker-compose.licensed.yml up -d
#
# 2. IRIS will be available on these ports:
#    - SuperServer: localhost:21972 (for applications)
#    - Management Portal: http://localhost:252773/csp/sys/UtilHome.csp
#    - Credentials: _SYSTEM / SYS
#
# 3. Update .env file for licensed IRIS ports:
#    IRIS_PORT=21972
#    IRIS_WEBSERVER_PORT=252773
#
# 4. Performance benefits with licensed IRIS + iris_graph_core:
#    - ACORN=1 HNSW optimization (10-50x faster vector search)
#    - RRF fusion with optimized vector search
#    - Enhanced hybrid search performance
#    - Advanced analytics and ML capabilities
#
# 5. Database initialization:
#    make setup-db    # Creates all tables including iris_graph_core tables
#    make load-data   # Loads sample data with entity extraction
#
# 6. Test the hybrid search performance:
#    cd scripts/basic
#    python try_hybrid_graphrag_pipeline.py  # Uses iris_graph_core if available
#
# PORT MAPPING STRATEGY:
# - Community IRIS: 11972 (SuperServer), 152773 (Portal)
# - Licensed IRIS:  21972 (SuperServer), 252773 (Portal)
# - Standard IRIS:   1972 (SuperServer),  52773 (Portal) - reserved for existing installations
#
# Note: For public distribution, use docker-compose.yml (community edition)
#       This licensed version is for performance testing and enterprise deployment