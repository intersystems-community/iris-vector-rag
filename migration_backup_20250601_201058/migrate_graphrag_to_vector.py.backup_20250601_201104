#!/usr/bin/env python3
"""
Migrate GraphRAG tables from VARCHAR to VECTOR columns with HNSW indexes
"""

import sys
import time
sys.path.append('.')

from common.iris_connector import get_iris_connection

def migrate_graphrag_tables():
    """Migrate Entities and SourceDocuments to VECTOR columns"""
    print("üöÄ Migrating GraphRAG Tables to VECTOR Type")
    print("=" * 60)
    
    iris = get_iris_connection()
    cursor = iris.cursor()
    
    try:
        # Step 1: Check current state
        print("\n1Ô∏è‚É£ Checking current table state...")
        
        cursor.execute("SELECT COUNT(*) FROM RAG.SourceDocuments WHERE embedding IS NOT NULL")
        source_count = cursor.fetchone()[0]
        print(f"   SourceDocuments with embeddings: {source_count:,}")
        
        cursor.execute("SELECT COUNT(*) FROM RAG.Entities WHERE embedding IS NOT NULL")
        entity_count = cursor.fetchone()[0]
        print(f"   Entities with embeddings: {entity_count:,}")
        
        # Step 2: Create new tables with VECTOR columns
        print("\n2Ô∏è‚É£ Creating new tables with VECTOR columns...")
        
        # Drop existing tables if they exist
        try:
            cursor.execute("DROP TABLE RAG.SourceDocuments_V3")
            print("   Dropped existing SourceDocuments_V3")
        except:
            pass
            
        try:
            cursor.execute("DROP TABLE RAG.Entities_V2")
            print("   Dropped existing Entities_V2")
        except:
            pass
        
        iris.commit()
        
        # Create SourceDocuments_V3 (in case V2 exists)
        print("   Creating RAG.SourceDocuments_V3...")
        cursor.execute("""
            CREATE TABLE RAG.SourceDocuments_V3 (
                doc_id VARCHAR(255) PRIMARY KEY,
                title VARCHAR(1000),
                text_content TEXT,
                authors TEXT,
                keywords TEXT,
                embedding VECTOR(DOUBLE, 384),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        
        # Create Entities_V2
        print("   Creating RAG.Entities_V2...")
        cursor.execute("""
            CREATE TABLE RAG.Entities_V2 (
                entity_id VARCHAR(255) PRIMARY KEY,
                entity_name VARCHAR(500) NOT NULL,
                entity_type VARCHAR(100),
                source_doc_id VARCHAR(255),
                embedding VECTOR(DOUBLE, 384),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        
        iris.commit()
        print("   ‚úÖ New tables created")
        
        # Step 3: Migrate data with progress tracking
        print("\n3Ô∏è‚É£ Migrating data to new tables...")
        
        # Migrate SourceDocuments
        if source_count > 0:
            print(f"\n   Migrating {source_count:,} SourceDocuments...")
            start_time = time.time()
            
            # Simple migration without batching
            cursor.execute("""
                INSERT INTO RAG.SourceDocuments_V3 (doc_id, title, text_content, authors, keywords, embedding, created_at)
                SELECT doc_id, title, text_content, authors, keywords,
                       CASE
                           WHEN embedding IS NOT NULL AND embedding != ''
                           THEN TO_VECTOR(embedding)
                           ELSE NULL
                       END,
                       created_at
                FROM RAG.SourceDocuments
                WHERE embedding IS NOT NULL
            """)
            
            iris.commit()
            elapsed = time.time() - start_time
            print(f"   ‚úÖ SourceDocuments migrated in {elapsed:.1f} seconds")
        
        # Migrate Entities
        if entity_count > 0:
            print(f"\n   Migrating {entity_count:,} Entities...")
            start_time = time.time()
            
            # Simple migration without batching
            cursor.execute("""
                INSERT INTO RAG.Entities_V2 (entity_id, entity_name, entity_type, source_doc_id, embedding, created_at)
                SELECT entity_id, entity_name, entity_type, source_doc_id,
                       CASE
                           WHEN embedding IS NOT NULL AND embedding != ''
                           THEN TO_VECTOR(embedding)
                           ELSE NULL
                       END,
                       created_at
                FROM RAG.Entities
                WHERE embedding IS NOT NULL
            """)
            
            iris.commit()
            elapsed = time.time() - start_time
            print(f"   ‚úÖ Entities migrated in {elapsed:.1f} seconds")
        
        # Step 4: Create HNSW indexes
        print("\n4Ô∏è‚É£ Creating HNSW indexes...")
        
        print("   Creating HNSW index on SourceDocuments_V3...")
        cursor.execute("""
            CREATE INDEX idx_hnsw_source_v3 
            ON RAG.SourceDocuments_V3 (embedding) 
            AS HNSW(M=16, efConstruction=200, Distance='COSINE')
        """)
        print("   ‚úÖ Created idx_hnsw_source_v3")
        
        print("   Creating HNSW index on Entities_V2...")
        cursor.execute("""
            CREATE INDEX idx_hnsw_entity_v2 
            ON RAG.Entities_V2 (embedding) 
            AS HNSW(M=16, efConstruction=200, Distance='COSINE')
        """)
        print("   ‚úÖ Created idx_hnsw_entity_v2")
        
        # Create other useful indexes
        print("\n   Creating supporting indexes...")
        cursor.execute("CREATE INDEX idx_entity_v2_name ON RAG.Entities_V2 (entity_name)")
        cursor.execute("CREATE INDEX idx_entity_v2_type ON RAG.Entities_V2 (entity_type)")
        cursor.execute("CREATE INDEX idx_entity_v2_doc ON RAG.Entities_V2 (source_doc_id)")
        
        iris.commit()
        print("   ‚úÖ All indexes created")
        
        # Step 5: Test performance
        print("\n5Ô∏è‚É£ Testing vector search performance...")
        
        # Test Entities_V2
        start_time = time.time()
        cursor.execute("""
            SELECT TOP 10 entity_name
            FROM RAG.Entities_V2
            WHERE embedding IS NOT NULL
            ORDER BY VECTOR_COSINE(embedding, embedding) DESC
        """)
        results = cursor.fetchall()
        elapsed = (time.time() - start_time) * 1000
        
        print(f"   Entities_V2 query time: {elapsed:.2f} ms")
        if elapsed < 100:
            print("   üöÄ EXCELLENT: HNSW index is working!")
        
        # Test SourceDocuments_V3
        start_time = time.time()
        cursor.execute("""
            SELECT TOP 10 doc_id
            FROM RAG.SourceDocuments_V3
            WHERE embedding IS NOT NULL
            ORDER BY VECTOR_COSINE(embedding, embedding) DESC
        """)
        results = cursor.fetchall()
        elapsed = (time.time() - start_time) * 1000
        
        print(f"   SourceDocuments_V3 query time: {elapsed:.2f} ms")
        if elapsed < 100:
            print("   üöÄ EXCELLENT: HNSW index is working!")
        
        print("\n‚úÖ Migration completed successfully!")
        print("\nüìù Next steps:")
        print("   1. Update your code to use the new tables:")
        print("      - RAG.SourceDocuments_V3 (instead of RAG.SourceDocuments)")
        print("      - RAG.Entities_V2 (instead of RAG.Entities)")
        print("   2. Test your applications with the new tables")
        print("   3. Once verified, rename tables:")
        print("      - Rename SourceDocuments to SourceDocuments_OLD")
        print("      - Rename SourceDocuments_V3 to SourceDocuments")
        print("      - Rename Entities to Entities_OLD")
        print("      - Rename Entities_V2 to Entities")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
    finally:
        cursor.close()
        iris.close()

if __name__ == "__main__":
    migrate_graphrag_tables()