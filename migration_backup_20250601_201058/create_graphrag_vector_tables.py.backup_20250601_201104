#!/usr/bin/env python3
"""
Create GraphRAG tables with proper VECTOR type and HNSW indexes
"""

import sys
sys.path.append('.')

from common.iris_connector import get_iris_connection

def create_vector_tables():
    """Create GraphRAG tables with VECTOR type and HNSW indexes"""
    print("üöÄ Creating GraphRAG Tables with VECTOR Type and HNSW Indexes")
    print("=" * 60)
    
    iris = get_iris_connection()
    cursor = iris.cursor()
    
    try:
        # Step 1: Drop existing tables
        print("\n1Ô∏è‚É£ Dropping existing tables...")
        
        try:
            cursor.execute("DROP TABLE RAG.Relationships")
            print("   ‚úÖ Dropped Relationships table")
        except:
            print("   ‚ÑπÔ∏è  Relationships table doesn't exist")
        
        try:
            cursor.execute("DROP TABLE RAG.Entities")
            print("   ‚úÖ Dropped Entities table")
        except:
            print("   ‚ÑπÔ∏è  Entities table doesn't exist")
        
        iris.commit()
        
        # Step 2: Create tables with VECTOR type
        print("\n2Ô∏è‚É£ Creating tables with VECTOR type...")
        
        # Create Entities table with VECTOR type
        cursor.execute("""
            CREATE TABLE RAG.Entities (
                entity_id VARCHAR(255) PRIMARY KEY,
                entity_name VARCHAR(500) NOT NULL,
                entity_type VARCHAR(100),
                source_doc_id VARCHAR(255),
                embedding VECTOR(DOUBLE, 384),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        print("   ‚úÖ Created Entities table with VECTOR(DOUBLE, 384)")
        
        # Create Relationships table
        cursor.execute("""
            CREATE TABLE RAG.Relationships (
                relationship_id VARCHAR(255) PRIMARY KEY,
                source_entity_id VARCHAR(255),
                target_entity_id VARCHAR(255),
                relationship_type VARCHAR(100),
                source_doc_id VARCHAR(255),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (source_entity_id) REFERENCES RAG.Entities(entity_id),
                FOREIGN KEY (target_entity_id) REFERENCES RAG.Entities(entity_id)
            )
        """)
        print("   ‚úÖ Created Relationships table")
        
        iris.commit()
        
        # Step 3: Create HNSW indexes
        print("\n3Ô∏è‚É£ Creating HNSW indexes...")
        
        # Create HNSW index on entity embeddings
        cursor.execute("""
            CREATE VECTOR INDEX idx_entity_embedding_hnsw 
            ON RAG.Entities (embedding) 
            USING HNSW 
            WITH ('dim' = 384, 'M' = 16, 'efConstruction' = 200)
        """)
        print("   ‚úÖ Created HNSW index on Entities.embedding")
        
        # Create other useful indexes
        indexes = [
            ("CREATE INDEX idx_entity_name ON RAG.Entities (entity_name)", "entity_name"),
            ("CREATE INDEX idx_entity_type ON RAG.Entities (entity_type)", "entity_type"),
            ("CREATE INDEX idx_entity_doc ON RAG.Entities (source_doc_id)", "source_doc_id"),
            ("CREATE INDEX idx_rel_source ON RAG.Relationships (source_entity_id)", "source relationship"),
            ("CREATE INDEX idx_rel_target ON RAG.Relationships (target_entity_id)", "target relationship"),
            ("CREATE INDEX idx_rel_type ON RAG.Relationships (relationship_type)", "relationship type")
        ]
        
        for sql, desc in indexes:
            try:
                cursor.execute(sql)
                print(f"   ‚úÖ Created index on {desc}")
            except Exception as e:
                print(f"   ‚ö†Ô∏è  Could not create index on {desc}: {e}")
        
        iris.commit()
        
        # Step 4: Verify HNSW index on SourceDocuments
        print("\n4Ô∏è‚É£ Checking SourceDocuments HNSW index...")
        
        cursor.execute("""
            SELECT COUNT(*) 
            FROM %Dictionary.CompiledIndex 
            WHERE Parent = 'RAG.SourceDocuments' 
            AND Name LIKE '%embedding%'
        """)
        source_doc_indexes = cursor.fetchone()[0]
        
        if source_doc_indexes == 0:
            print("   ‚ö†Ô∏è  No HNSW index found on SourceDocuments.embedding")
            print("   Creating HNSW index on SourceDocuments...")
            try:
                cursor.execute("""
                    CREATE VECTOR INDEX idx_sourcedoc_embedding_hnsw 
                    ON RAG.SourceDocuments (embedding) 
                    USING HNSW 
                    WITH ('dim' = 384, 'M' = 16, 'efConstruction' = 200)
                """)
                print("   ‚úÖ Created HNSW index on SourceDocuments.embedding")
            except Exception as e:
                print(f"   ‚ö†Ô∏è  Could not create HNSW index: {e}")
        else:
            print(f"   ‚úÖ Found {source_doc_indexes} index(es) on SourceDocuments.embedding")
        
        iris.commit()
        
        # Step 5: Test vector operations
        print("\n5Ô∏è‚É£ Testing vector operations...")
        
        # Insert test entity
        from common.embedding_utils import get_embedding_model
        embedding_model = get_embedding_model('sentence-transformers/all-MiniLM-L6-v2')
        
        test_embedding = embedding_model.encode(["test entity"])[0]
        
        cursor.execute("""
            INSERT INTO RAG.Entities (entity_id, entity_name, entity_type, embedding)
            VALUES ('test-1', 'test entity', 'TEST', TO_VECTOR(?))
        """, [str(test_embedding.tolist())])
        
        # Test vector search
        query_embedding = embedding_model.encode(["query test"])[0]
        cursor.execute("""
            SELECT entity_name, 
                   VECTOR_COSINE(embedding, TO_VECTOR(?)) as similarity
            FROM RAG.Entities
            WHERE entity_id = 'test-1'
        """, [str(query_embedding.tolist())])
        
        result = cursor.fetchone()
        if result:
            print(f"   ‚úÖ Vector operations working! Similarity: {result[1]:.4f}")
        
        # Clean up test data
        cursor.execute("DELETE FROM RAG.Entities WHERE entity_id = 'test-1'")
        iris.commit()
        
        print("\n‚úÖ GraphRAG tables created successfully with:")
        print("   - VECTOR(DOUBLE, 384) type for embeddings")
        print("   - HNSW indexes for fast similarity search")
        print("   - All necessary supporting indexes")
        
        print("\nüìù Table definitions:")
        print("   RAG.Entities: entity_id, entity_name, entity_type, source_doc_id, embedding VECTOR(DOUBLE, 384)")
        print("   RAG.Relationships: relationship_id, source_entity_id, target_entity_id, relationship_type, source_doc_id")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        import traceback
        traceback.print_exc()
    finally:
        cursor.close()
        iris.close()

if __name__ == "__main__":
    create_vector_tables()